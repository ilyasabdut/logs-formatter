name: Build and Deploy Log Formatter

on:
  push:
    branches:
      - master # Or 'main'

jobs:
  build-and-push-image:
    name: Build and Push Log Formatter Image
    runs-on: ubuntu-24.04-arm
    environment: master

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Log in to Docker Registry
        uses: docker/login-action@v3
        with:
          registry: registry.ilyasabdut.loseyourip.com
          username: ${{ secrets.REGISTRY_USERNAME }}
          password: ${{ secrets.REGISTRY_PASSWORD }}

      - name: Build and Push Log Formatter Image
        uses: docker/build-push-action@v5
        with:
          context: .
          file: Dockerfile
          platforms: linux/arm64
          push: true
          tags: registry.ilyasabdut.loseyourip.com/log-formatter:latest

  # deploy-on-vps:
  #   name: Deploy Log Formatter to VPS
  #   needs: build-and-push-image
  #   runs-on: ubuntu-24.04-arm
  #   environment: master

  #   steps:
  #     - name: Log in to Docker Registry (on deployment runner/VPS)
  #       run: |
  #         echo "${{ secrets.REGISTRY_PASSWORD }}" | docker login registry.ilyasabdut.loseyourip.com -u "${{ secrets.REGISTRY_USERNAME }}" --password-stdin

  #     - name: Deploy Log Formatter App
  #       run: |
  #         echo "Deploying Log Formatter on $(hostname)"
  #
  #         APP_COMPOSE_DIR="/home/ubuntu/composes/log-formatter" # ADJUST THIS PATH
  #
  #         if [ ! -d "${APP_COMPOSE_DIR}" ]; then
  #           echo "ERROR: Deployment directory ${APP_COMPOSE_DIR} does not exist!"
  #           exit 1
  #         fi
  #         cd "${APP_COMPOSE_DIR}"
  #         echo "Changed directory to $(pwd)"

  #         echo "Ensuring .env file exists (if needed)..."
  #         # Note: This app may not need .env since it's fully client-side
  #         # if [ ! -f .env ]; then
  #         #   echo "ERROR: .env file not found in ${APP_COMPOSE_DIR}."
  #         #   exit 1
  #         # fi

  #         echo "Pulling latest image..."
  #         docker compose pull log-formatter-web
  #
  #         echo "Restarting container..."
  #         docker compose up -d --force-recreate --remove-orphans

  #         echo "Cleaning up unused Docker images (optional)..."
  #         docker image prune -af

  #         echo "Log Formatter deployment finished!"
  #       env:
  #         REGISTRY_USERNAME: ${{ secrets.REGISTRY_USERNAME }}
  #         REGISTRY_PASSWORD: ${{ secrets.REGISTRY_PASSWORD }}
